name: Deploy Airflow

on:
  push:
    branches:
      - main
    paths:
      - 'airflow/**'

jobs:
  validate:
    name: Validate DAGs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate DAG syntax
        run: |
          echo "Validating DAG files..."
          for file in airflow/dags/*.py; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              python -m py_compile "$file"
            fi
          done
          echo "All DAGs validated successfully!"

  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need to detect changed files

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AIRFLOW_SSH_KEY }}" > ~/.ssh/airflow_key
          chmod 600 ~/.ssh/airflow_key
          ssh-keyscan -H ${{ secrets.AIRFLOW_VM_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install rsync
        run: |
          sudo apt-get update && sudo apt-get install -y rsync

      - name: Deploy DAGs and Plugins
        run: |
          echo "Deploying DAGs and plugins to Airflow VM..."

          # Sync DAGs folder
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/airflow_key -o StrictHostKeyChecking=no" \
            airflow/dags/ \
            ${{ secrets.AIRFLOW_SSH_USER }}@${{ secrets.AIRFLOW_VM_IP }}:/tmp/dags/

          # Sync plugins folder
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/airflow_key -o StrictHostKeyChecking=no" \
            airflow/plugins/ \
            ${{ secrets.AIRFLOW_SSH_USER }}@${{ secrets.AIRFLOW_VM_IP }}:/tmp/plugins/

          # Move to correct location and fix permissions
          ssh -i ~/.ssh/airflow_key -o StrictHostKeyChecking=no \
            ${{ secrets.AIRFLOW_SSH_USER }}@${{ secrets.AIRFLOW_VM_IP }} \
            'sudo rsync -av --delete /tmp/dags/ /opt/airflow/dags/ && \
             sudo rsync -av --delete /tmp/plugins/ /opt/airflow/plugins/ && \
             sudo chown -R 50000:0 /opt/airflow/dags/ /opt/airflow/plugins/'

          echo "DAGs and plugins deployed successfully!"

      - name: Check if rebuild needed
        id: check_rebuild
        run: |
          # Check if Dockerfile or docker-compose changed
          if git diff --name-only HEAD~1 HEAD | grep -qE 'airflow/(Dockerfile|docker-compose.yaml)'; then
            echo "rebuild=true" >> $GITHUB_OUTPUT
            echo "Dockerfile or docker-compose.yaml changed - rebuild needed"
          else
            echo "rebuild=false" >> $GITHUB_OUTPUT
            echo "No rebuild needed"
          fi

      - name: Rebuild Airflow containers
        if: steps.check_rebuild.outputs.rebuild == 'true'
        run: |
          echo "Rebuilding Airflow containers..."

          # Copy updated files
          rsync -avz \
            -e "ssh -i ~/.ssh/airflow_key -o StrictHostKeyChecking=no" \
            airflow/Dockerfile airflow/docker-compose.yaml \
            ${{ secrets.AIRFLOW_SSH_USER }}@${{ secrets.AIRFLOW_VM_IP }}:/opt/airflow/

          # Rebuild and restart
          ssh -i ~/.ssh/airflow_key -o StrictHostKeyChecking=no \
            ${{ secrets.AIRFLOW_SSH_USER }}@${{ secrets.AIRFLOW_VM_IP }} \
            'cd /opt/airflow && sudo docker-compose down && sudo docker-compose build --no-cache && sudo docker-compose up -d'

          echo "Airflow containers rebuilt and restarted!"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/airflow_key
